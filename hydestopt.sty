\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{hydestopt}[2006/05/30]

\RequirePackage{alphalph}

\begingroup
  \toks0{%
    \if@filesw
      \immediate\write\@mainaux{%
        \string\providecommand*{\string\hydest@use}[1]{}%
      }%
    \fi
  }%
  \toks2\expandafter{\@begindocumenthook}%
  \xdef\@begindocumenthook{\the\toks0 \the\toks2}%
\endgroup

\newcounter{HyDest}
\def\HyDest@hexchar#1{%
  \ifcase#1\or
    00\or 01\or 02\or 03\or 04\or 05\or 06\or 07\or
    08\or 09\or 0A\or 0B\or 0C\or 0E\or 0F\or       % dropped: ^^M
    10\or 11\or 12\or 13\or 14\or 15\or 16\or 17\or
    18\or 19\or 1A\or 1B\or 1C\or 1D\or 1E\or 1F\or
    20\or 21\or 22\or 23\or 24\or 25\or 26\or 27\or
    2A\or 2B\or 2C\or 2D\or 2E\or 2F\or             % dropped: (, )
    30\or 31\or 32\or 33\or 34\or 35\or 36\or 37\or
    38\or 39\or 3A\or 3B\or 3C\or 3D\or 3E\or 3F\or
    40\or 41\or 42\or 43\or 44\or 45\or 46\or 47\or
    48\or 49\or 4A\or 4B\or 4C\or 4D\or 4E\or 4F\or
    50\or 51\or 52\or 53\or 54\or 55\or 56\or 57\or
    58\or 59\or 5A\or 5B\or 5D\or 5E\or 5F\or       % dropped: \
    60\or 61\or 62\or 63\or 64\or 65\or 66\or 67\or
    68\or 69\or 6A\or 6B\or 6C\or 6D\or 6E\or 6F\or
    70\or 71\or 72\or 73\or 74\or 75\or 76\or 77\or
    78\or 79\or 7A\or 7B\or 7C\or 7D\or 7E\or 7F\or
    80\or 81\or 82\or 83\or 84\or 85\or 86\or 87\or
    88\or 89\or 8A\or 8B\or 8C\or 8D\or 8E\or 8F\or
    90\or 91\or 92\or 93\or 94\or 95\or 96\or 97\or
    98\or 99\or 9A\or 9B\or 9C\or 9D\or 9E\or 9F\or
    A0\or A1\or A2\or A3\or A4\or A5\or A6\or A7\or
    A8\or A9\or AA\or AB\or AC\or AD\or AE\or AF\or
    B0\or B1\or B2\or B3\or B4\or B5\or B6\or B7\or
    B8\or B9\or BA\or BB\or BC\or BD\or BE\or BF\or
    C0\or C1\or C2\or C3\or C4\or C5\or C6\or C7\or
    C8\or C9\or CA\or CB\or CC\or CD\or CE\or CF\or
    D0\or D1\or D2\or D3\or D4\or D5\or D6\or D7\or
    D8\or D9\or DA\or DB\or DC\or DD\or DE\or DF\or
    E0\or E1\or E2\or E3\or E4\or E5\or E6\or E7\or
    E8\or E9\or EA\or EB\or EC\or ED\or EE\or EF\or
    F0\or F1\or F2\or F3\or F4\or F5\or F6\or F7\or
    F8\or F9\or FA\or FB\or FC\or FD\or FE\or FF%
  \else XX%
  \fi
}
\newalphalph\HyDest@hexstring\HyDest@hexchar{252}% 256 - 4
\renewcommand*{\theHyDest}{%
  \pdfunescapehex{\HyDest@hexstring{\value{HyDest}}}%
}
 
\def\hydest@use#1{%
  \begingroup
    \edef\x{%
      \expandafter\noexpand\csname HyD@\pdfunescapehex{#1}\endcsname
    }%
    \expandafter\ifx\x\relax
      \stepcounter{HyDest}%
% \typeout{* hydest@use: \number\value{HyDest} (\pdfescapehex{\theHyDest})
%  \pdfunescapehex{#1}}%
      \expandafter\xdef\x{\theHyDest}%
    \fi
  \endgroup
}

\AtBeginDocument{%
  \let\HyDest@org@new@pdflink\new@pdflink
  \renewcommand*{\new@pdflink}{%
    \let\HyDest@org@pdfdest\pdfdest
    \def\pdfdest##1name##2##3\relax{%
      \let\pdfdest\HyDest@org@pdfdest
      \@ifundefined{HyD@##2}{%
      }{%
  % \typeout{* DEST: ##2 (\pdfescapehex{##2})
  % -> \pdfescapehex{\csname HyD@##2\endcsname}}%
        \pdfdest##1name{\csname HyD@##2\endcsname}##3\relax
      }%
    }%
    \HyDest@org@new@pdflink
  }%
  %
  \let\HyDest@org@find@pdflink\find@pdflink
  \renewcommand*{\find@pdflink}{%
    \let\HyDest@org@pdfstartlink\pdfstartlink
    \def\pdfstartlink##1goto name##2{%
      \let\pdfstartlink\HyDest@org@pdfstartlink
      \if@filesw
        \immediate\write\@auxout{%
          \string\hydest@use{\pdfescapehex{##2}}%
        }%
      \fi
      \pdfstartlink##1goto name{%
        \@ifundefined{HyD@##2}{%
          ##2%
        }{%
          \csname HyD@##2\endcsname
        }%
      }%
    }%
    \HyDest@org@find@pdflink
  }%
}

\let\HyDest@org@pdfoutline\pdfoutline
\def\pdfoutline goto name#1{%
  \if@filesw
    \immediate\write\@auxout{%
      \string\hydest@use{\pdfescapehex{#1}}%
    }%
  \fi
  \HyDest@org@pdfoutline goto name{%
    \@ifundefined{HyD@#1}{%
      #1%
    }{%
      \csname HyD@#1\endcsname
    }%
  }%
}

\endinput
